import streamlit as st
import datetime
import streamlit_option_menu as option_menu
import geocoder
from PIL import Image
import io
import base64
import requests
import json

# å®šç¾©ä¸»è‰²ç³»
PRIMARY_COLOR = "#D32F2F"
SECONDARY_COLOR = "#FFFFFF"
ACCENT_COLOR = "#0D47A1"

st.set_page_config(page_title="GreenTrace", page_icon="ğŸš‘", layout="wide")

# CSS è¨­å®š
st.markdown(f"""
    <style>
        .main {{ background-color: {SECONDARY_COLOR}; }}
        h1, h2, h3, h4, h5, h6 {{ color: {PRIMARY_COLOR}; }}
        .stButton>button {{ background-color: {PRIMARY_COLOR}; color: {SECONDARY_COLOR}; }}
    </style>
""", unsafe_allow_html=True)

# åˆå§‹åŒ– session_state
if "authenticated" not in st.session_state:
    st.session_state.authenticated = False
if "username" not in st.session_state:
    st.session_state.username = ""
if "logout_confirm" not in st.session_state:
    st.session_state.logout_confirm = False
if "current_suggestion" not in st.session_state:
    st.session_state.current_suggestion = None
if "current_task" not in st.session_state:
    st.session_state.current_task = None
if "completed_tasks" not in st.session_state:
    st.session_state.completed_tasks = 0
if "users" not in st.session_state:
    st.session_state.users = []  # å„²å­˜ä½¿ç”¨è€…è³‡æ–™
if "profile" not in st.session_state:
    st.session_state.profile = {"skill": "", "completed_tasks": 0, "volunteer_level": "åˆç´šå¿—å·¥"}

# å´é‚Šå°èˆª
if not st.session_state.authenticated:
    menu_options = ["Login/Signup"]
    icons = ["box-arrow-in-right"]
else:
    menu_options = ["Emergency", "Tasks", "Legal Record", "Profile", "Logout"]
    icons = ["exclamation-triangle-fill", "list-task", "file-earmark-lock2", "person-circle", "box-arrow-left"]

with st.sidebar:
    selected = option_menu.option_menu(
        menu_title="GreenTrace",
        options=menu_options,
        icons=icons,
        menu_icon="heartbeat",
        default_index=0,
        styles={
            "container": {"background-color": "#f8f9fa"},
            "icon": {"color": PRIMARY_COLOR, "font-size": "24px"},
            "nav-link-selected": {"background-color": PRIMARY_COLOR}
        }
    )

# é¡¯ç¤ºåœ–ç‰‡
def display_image(image):
    img = Image.open(image)
    st.image(img, caption="å·²ä¸Šå‚³çš„å‚·æ‚£ç…§ç‰‡", use_column_width=True)

# å°‡åœ–ç‰‡è½‰ç‚º base64
def image_to_base64(image):
    buffered = io.BytesIO()
    image.save(buffered, format="PNG")
    return base64.b64encode(buffered.getvalue()).decode()

# é€é xAI API ç²å– LLM å»ºè­°
def get_llm_suggestion(description, image_base64=None):
    api_key = st.secrets.get("XAI_API_KEY", None)
    if not api_key:
        return "éŒ¯èª¤ï¼šæœªè¨­å®š xAI API é‡‘é‘°ã€‚è«‹åœ¨ Streamlit è¨­å®šä¸­æ–°å¢ API é‡‘é‘°ã€‚"
    
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }
    
    prompt = f"æ‚¨æ˜¯ä¸€ä½é†«ç™‚æ€¥æ•‘å°ˆå®¶ã€‚æ ¹æ“šä»¥ä¸‹å‚·æ‚£æè¿°ï¼š\n{description}\nè«‹åˆ†æä¸¦æä¾›å…·é«”çš„é†«ç™‚å»ºè­°ã€‚å¦‚æœæœ‰åœ–ç‰‡ï¼Œè«‹çµåˆåœ–ç‰‡å…§å®¹é€²è¡Œåˆ†æã€‚"
    
    payload = {
        "model": "grok-3",
        "messages": [
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt}
                ]
            }
        ]
    }
    
    if image_base64:
        payload["messages"][0]["content"].append({
            "type": "image_url",
            "image_url": {"url": f"data:image/png;base64,{image_base64}"}
        })
    
    try:
        response = requests.post("https://api.x.ai/v1/chat/completions", headers=headers, json=payload)
        response.raise_for_status()
        result = response.json()
        return result["choices"][0]["message"]["content"]
    except Exception as e:
        return f"éŒ¯èª¤ï¼šç„¡æ³•ç²å– LLM å»ºè­°ã€‚è©³ç´°éŒ¯èª¤ï¼š{str(e)}"

# ç™»å…¥èˆ‡è¨»å†Šé‚è¼¯
if selected == "Login/Signup":
    st.title("GreenTrace - ç™»å…¥/è¨»å†Š")
    action = st.radio("æƒ³è¦ç™»å…¥é‚„æ˜¯è¨»å†Šï¼Ÿ", ("Login", "Signup"))

    if action == "Login":
        email = st.text_input("é›»å­éƒµä»¶")
        password = st.text_input("å¯†ç¢¼", type="password")
        if st.button("ç™»å…¥"):
            user = next((u for u in st.session_state.users if u["email"] == email and u["password"] == password), None)
            if user:
                st.session_state.authenticated = True
                st.session_state.username = user["name"]
                st.session_state.profile = {
                    "skill": user.get("skill", ""),
                    "completed_tasks": int(user.get("completed_tasks", 0)),
                    "volunteer_level": user.get("volunteer_level", "åˆç´šå¿—å·¥")
                }
                st.success(f"æ­¡è¿å›ä¾†ï¼Œ{user['name']}ï¼è«‹å¾å·¦å´é¸å–®ç¹¼çºŒä½¿ç”¨åŠŸèƒ½ã€‚")
                st.rerun()
            else:
                st.error("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤")

    else:
        name = st.text_input("å§“å")
        email = st.text_input("é›»å­éƒµä»¶")
        password = st.text_input("è¨»å†Šå¯†ç¢¼", type="password")
        confirm = st.text_input("ç¢ºèªå¯†ç¢¼", type="password")
        if st.button("è¨»å†Š"):
            if not name or not email or not password:
                st.warning("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½")
            elif password != confirm:
                st.warning("å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´")
            elif any(u["email"] == email for u in st.session_state.users):
                st.warning("æ­¤ Email å·²ç¶“è¨»å†Šé")
            else:
                st.session_state.users.append({
                    "name": name,
                    "email": email,
                    "password": password,
                    "skill": "",
                    "completed_tasks": "0",
                    "volunteer_level": "åˆç´šå¿—å·¥"
                })
                st.success("âœ… è¨»å†ŠæˆåŠŸï¼è«‹è¿”å›ç™»å…¥")

elif selected == "Logout":
    if not st.session_state.logout_confirm:
        st.warning("âš ï¸ æ‚¨å³å°‡ç™»å‡ºç³»çµ±ã€‚")
        if st.button("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ"):
            st.session_state.logout_confirm = True
    else:
        st.markdown("### æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")
        if st.button("æ˜¯ï¼Œæˆ‘è¦ç™»å‡º"):
            st.session_state.authenticated = False
            st.session_state.username = ""
            st.session_state.logout_confirm = False
            st.session_state.profile = {"skill": "", "completed_tasks": 0, "volunteer_level": "åˆç´šå¿—å·¥"}
            st.success("æ‚¨å·²æˆåŠŸç™»å‡ºã€‚")
            st.rerun()
        
        with st.container():
            st.markdown("<br>", unsafe_allow_html=True)
            if st.button("å¦ï¼Œå›ä¸Šä¸€é "):
                st.session_state.logout_confirm = False
                st.rerun()

# è™•ç† "Emergency"ã€"Tasks"ã€"Legal Record"ã€"Profile" çš„é‚è¼¯
if st.session_state.authenticated:
    if selected == "Emergency":
        st.title("ğŸš¨ ç·Šæ€¥é€šå ±")
        st.metric(label="ç•¶å‰ä½ç½®", value="25.0478Â°N, 121.5319Â°E")
        g = geocoder.ip('me')
        if g.ok:
            lat, lon = g.latlng
            st.map({'lat': [lat], 'lon': [lon]})
        else:
            st.error("ç„¡æ³•ç²å–ç•¶å‰ä½ç½®ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ–é‡æ–°è¼‰å…¥é é¢")
        if st.button("ä¸€éµæ±‚æ•‘"):
            st.success("ç·Šæ€¥æ¶ˆæ¯å·²ç™¼é€ï¼")

    elif selected == "Tasks":
        if st.session_state.current_task is None:
            st.title("ğŸ—’ï¸ ä»»å‹™æ¸…å–®")
            st.subheader("è«‹é¸æ“‡ä¸€é …ä»»å‹™æŸ¥çœ‹è©³æƒ…")

            if st.button("ğŸ§­ å®‰å…¨å±‹è·¯ç·šå”åŠ©"):
                st.session_state.current_task = "rescue_route"
                st.rerun()
            if st.button("ğŸš¦ å”åŠ©äº¤é€šæŒ‡æ®"):
                st.session_state.current_task = "traffic_control"
                st.rerun()
            if st.button("ğŸ©º å‚·æ‚£ç‹€æ³å ±å‘Š"):
                st.session_state.current_task = "medical_report"
                st.rerun()

        else:
            task = st.session_state.current_task
            if task == "rescue_route":
                st.title("ğŸ§­ å®‰å…¨å±‹è·¯ç·šå”åŠ©")
                st.write("æè¿°ï¼šå”åŠ©æŒ‡å¼•å—ç½æ°‘çœ¾å‰å¾€å®‰å…¨å°å±‹...")
            elif task == "traffic_control":
                st.title("ğŸš¦ å”åŠ©äº¤é€šæŒ‡æ®")
                st.write("æè¿°ï¼šæ”¯æ´ç¾å ´äº¤ç®¡èˆ‡äººå“¡ç–å°...")
            elif task == "medical_report":
                st.title("ğŸ©º å‚·æ‚£ç‹€æ³å ±å‘Š")
                st.write("æè¿°ï¼šå”åŠ©ç´€éŒ„ä¸¦å›å ±ç¬¬ä¸€æ™‚é–“é†«ç™‚ç‹€æ³...")

                # ä¸Šå‚³å‚·æ‚£ç…§ç‰‡
                st.subheader("ä¸Šå‚³å‚·æ‚£ç…§ç‰‡")
                uploaded_image = st.file_uploader("è«‹ä¸Šå‚³å‚·æ‚£ç…§ç‰‡", type=["jpg", "jpeg", "png"])
                if uploaded_image is not None:
                    display_image(uploaded_image)
                    image = Image.open(uploaded_image)
                    image_base64 = image_to_base64(image)
                    st.session_state.uploaded_image = image_base64
                    st.success("ç…§ç‰‡å·²ä¸Šå‚³ï¼")

                # AI å‚·æ‚£è™•ç†å»ºè­°
                st.subheader("AI å‚·æ‚£è™•ç†å»ºè­°")
                user_input = st.text_area("æè¿°å‚·æ‚£å…·é«”ç‹€æ³ï¼ˆä¾‹å¦‚ï¼šå‚·å£ä½ç½®ã€åš´é‡ç¨‹åº¦ç­‰ï¼‰", "")
                if st.button("ç²å– AI å»ºè­°"):
                    if not user_input and not hasattr(st.session_state, "uploaded_image"):
                        st.warning("è«‹æä¾›å‚·æ‚£æè¿°æˆ–ä¸Šå‚³ç…§ç‰‡ä»¥ç²å–å»ºè­°ã€‚")
                    else:
                        image_base64 = st.session_state.uploaded_image if hasattr(st.session_state, "uploaded_image") else None
                        st.session_state.current_suggestion = get_llm_suggestion(user_input, image_base64)

                # é¡¯ç¤ºç•¶å‰å»ºè­°
                if st.session_state.current_suggestion:
                    st.markdown(f"**AI å»ºè­°**ï¼š{st.session_state.current_suggestion}")

            st.markdown("---")
            if st.button("â¬… è¿”å›ä»»å‹™åˆ—è¡¨"):
                st.session_state.current_task = None
                st.session_state.current_suggestion = None
                st.rerun()

            # è¨ˆç®—å®Œæˆä»»å‹™æ¬¡æ•¸
            task_count = 0
            if task == "rescue_route":
                task_count += 1
            elif task == "traffic_control":
                task_count += 1
            elif task == "medical_report":
                task_count += 1

            if st.button("ç¢ºèªå®Œæˆä»»å‹™"):
                st.session_state.completed_tasks += task_count
                completed_tasks = st.session_state.completed_tasks
                if completed_tasks >= 20:
                    st.session_state.profile["volunteer_level"] = "é‡‘ç´šå¿—å·¥"
                elif completed_tasks >= 10:
                    st.session_state.profile["volunteer_level"] = "éŠ€ç´šå¿—å·¥"
                else:
                    st.session_state.profile["volunteer_level"] = "åˆç´šå¿—å·¥"
                st.session_state.profile["completed_tasks"] = completed_tasks
                for user in st.session_state.users:
                    if user["name"] == st.session_state.username:
                        user["completed_tasks"] = str(completed_tasks)
                        user["volunteer_level"] = st.session_state.profile["volunteer_level"]
                st.success(f"å·²å®Œæˆ {task_count} å€‹ä»»å‹™ï¼æ‚¨çš„å¿—å·¥ç­‰ç´šï¼š{st.session_state.profile['volunteer_level']}")

    elif selected == "Legal Record":
        st.title("ğŸ“ƒ æ³•å¾‹ä¿éšœè¨»è¨˜")
        st.text_area("ç¾å ´è¡Œå‹•è‡ªè¨´", "è‡ªé¡˜åƒèˆ‡æ•‘æ´ï¼Œä¿è­·å‚·è€…ç”Ÿå‘½...")
        uploaded_files = st.file_uploader("ä¸Šå‚³ç¾å ´ç…§ç‰‡æˆ–éŒ„éŸ³", accept_multiple_files=True)
        if st.button("ç¢ºèªå„²å­˜"):
            st.success("å·²å„²å­˜æ­¤æ¬¡è¡Œå‹•ç´€éŒ„èˆ‡è³‡æ–™ï¼")

    elif selected == "Profile":
        st.title("ğŸ‘¤ å¿—å·¥å€‹äººè³‡æ–™")
        st.image("https://upload.wikimedia.org/wikipedia/commons/thumb/8/89/Portrait_Placeholder.png/480px-Portrait_Placeholder.png", width=150)
        st.header(st.session_state.username)

        st.write(f"å¿—å·¥ç­‰ç´šï¼š{st.session_state.profile['volunteer_level']}")
        st.write(f"åƒèˆ‡ä»»å‹™ï¼š{st.session_state.profile['completed_tasks']} æ¬¡")
        st.write(f"å°ˆé•·æŠ€èƒ½ï¼š{st.session_state.profile['skill']}")

        st.subheader("æ›´æ–°å€‹äººè³‡æ–™")
        name = st.text_input("å§“å", value=st.session_state.username)
        skill = st.text_input("å°ˆé•·æŠ€èƒ½", value=st.session_state.profile["skill"])
        if st.button("å„²å­˜æ›´æ–°"):
            st.session_state.profile["skill"] = skill
            st.session_state.username = name
            for user in st.session_state.users:
                if user["name"] == st.session_state.username:
                    user["name"] = name
                    user["skill"] = skill
            st.success("è³‡æ–™å·²æ›´æ–°")